{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">ðŸ“Š Mon dashboard</h1>

    <!-- Formulaire pour changer la limite d'affichage -->
    <form method="GET" action="{{ url_for('main.dashboard') }}" class="mb-3">
        <label for="limit" class="form-label">Nombre d'Ã©lÃ©ments Ã  afficher :</label>
        <select name="limit" id="limit" class="form-select w-auto d-inline-block">
            {% for val in [10, 20, 30, 40, 50] %}
                <option value="{{ val }}" {% if val == limit %}selected{% endif %}>{{ val }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary ms-2">Appliquer</button>
    </form>

    <!-- Statistiques globales -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-bg-primary">
                <div class="card-body">
                    <h5 class="card-title">ðŸ“„ Articles</h5>
                    <p class="card-text fs-4">{{ dashboard.articles_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-success">
                <div class="card-body">
                    <h5 class="card-title">ðŸŽ¥ VidÃ©os</h5>
                    <p class="card-text fs-4">{{ dashboard.videos_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-warning">
                <div class="card-body">
                    <h5 class="card-title">ðŸ“š Articles scientifiques</h5>
                    <p class="card-text fs-4">{{ dashboard.scientific_articles_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section des articles rÃ©cents -->
    <h2>ðŸ“° Articles rÃ©cents</h2>
    <ul class="list-group mb-4">
        {% for article in dashboard.unique_articles %}
            <li class="list-group-item">
                <a href="{{ article.link }}" target="_blank">{{ article.title }}</a>
                <small class="text-muted">({{ article.source }}, {{ article.publication_date }}, {{ article.keywords }})</small>
            </li>
        {% else %}
            <li class="list-group-item text-muted">Aucun article rÃ©cent</li>
        {% endfor %}
    </ul>

    <!-- Section des derniers articles scientifiques -->
    <h2>ðŸ“– Derniers articles scientifiques</h2>
    <ul class="list-group mb-4">
        {% for article in dashboard.scientific_articles_by_keywords %}
            <li class="list-group-item">
                <a href="{{ article.article_url }}" target="_blank">{{ article.title }}</a>
                <small class="text-muted">({{ article.authors }}, {{ article.publication_date }}, {{ article.keywords }})</small>
            </li>
        {% else %}
            <li class="list-group-item text-muted">Aucun article scientifique rÃ©cent</li>
        {% endfor %}
    </ul>

    <!-- Section des derniÃ¨res vidÃ©os -->
    <h2>ðŸŽ¬ DerniÃ¨res vidÃ©os</h2>
    <ul class="list-group mb-4">
        {% for video in dashboard.latest_videos %}
            <li class="list-group-item">
                <a href="{{ video.video_url }}" target="_blank">{{ video.title }}</a>
                <small class="text-muted">({{ video.source }}, {{ video.publication_date }})</small>
            </li>
        {% else %}
            <li class="list-group-item text-muted">Aucune vidÃ©o rÃ©cente</li>
        {% endfor %}
    </ul>

    <!-- Section des tendances des mots-clÃ©s -->
    <h2>ðŸ“ˆ Tendances des mots-clÃ©s</h2>
    {% if dashboard.trending_keywords %}
        <div class="mt-4">
            <canvas id="keywordChart" style="height: 400px;"></canvas>
        </div>
    {% else %}
        <p class="text-muted">Aucune tendance dÃ©tectÃ©e rÃ©cemment.</p>
    {% endif %}
</div>

<!-- Script pour afficher le graphique des tendances -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var ctx = document.getElementById("keywordChart").getContext("2d");
        var trendingData = {{ dashboard.trending_keywords | tojson }};

        if (trendingData.length > 0) {
            var labels = [];
            var counts = [];

            trendingData.forEach(entry => {
                entry.keywords.forEach(keyword => {
                    let index = labels.indexOf(keyword.keyword);
                    if (index === -1) {
                        labels.push(keyword.keyword);
                        counts.push(keyword.count);
                    } else {
                        counts[index] += keyword.count;
                    }
                });
            });

            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Occurrences",
                        data: counts,
                        backgroundColor: "rgba(75, 192, 192, 0.6)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    });
</script>

{% endblock %}
