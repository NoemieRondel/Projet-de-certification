{% extends "base.html" %}

{% block content %}

<div class="container mt-4">
    <h2>Pr√©f√©rences Utilisateur</h2>

    <!-- Section r√©capitulative des pr√©f√©rences actuelles -->
    <div class="alert alert-info mt-3">
        <h5>üìå Vos pr√©f√©rences actuelles</h5>
        <ul class="mb-0">
            <li><strong>Sources d'articles :</strong> 
                {% if preferences.user_preferences.source_preferences %}
                    {{ preferences.user_preferences.source_preferences | join(", ") }}
                {% else %}
                    <span class="text-muted">Aucune s√©lectionn√©e</span>
                {% endif %}
            </li>
            <li><strong>Cha√Ænes vid√©o :</strong> 
                {% if preferences.user_preferences.video_channel_preferences %}
                    {{ preferences.user_preferences.video_channel_preferences | join(", ") }}
                {% else %}
                    <span class="text-muted">Aucune s√©lectionn√©e</span>
                {% endif %}
            </li>
            <li><strong>Mots-cl√©s :</strong> 
                {% if preferences.user_preferences.keyword_preferences %}
                    {{ preferences.user_preferences.keyword_preferences | join(", ") }}
                {% else %}
                    <span class="text-muted">Aucun s√©lectionn√©</span>
                {% endif %}
            </li>
        </ul>
    </div>
    
    <!-- Formulaire pour mettre √† jour les pr√©f√©rences -->
    <form method="POST" class="mt-3">
        <!-- S√©lection des sources pr√©f√©r√©es -->
        <div class="mb-3">
            <label for="source_preferences" class="form-label">Sources d'articles pr√©f√©r√©es :</label>
            <select id="source_preferences" name="source_preferences" class="form-select" multiple>
                {% for source in filters.available_filters.articles %}
                    <option value="{{ source }}" {% if source in preferences.user_preferences.source_preferences %}selected{% endif %}>
                        {{ source }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- S√©lection des cha√Ænes vid√©o pr√©f√©r√©es -->
        <div class="mb-3">
            <label for="video_channel_preferences" class="form-label">Cha√Ænes vid√©o pr√©f√©r√©es :</label>
            <select id="video_channel_preferences" name="video_channel_preferences" class="form-select" multiple>
                {% for channel in filters.available_filters.videos %}
                    <option value="{{ channel }}" {% if channel in preferences.user_preferences.video_channel_preferences %}selected{% endif %}>
                        {{ channel }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- S√©lection des mots-cl√©s pr√©f√©r√©s -->
        <div class="mb-3">
            <label for="keyword_preferences" class="form-label">Mots-cl√©s pr√©f√©r√©s :</label>
            <select id="keyword_preferences" name="keyword_preferences" class="form-select" multiple>
                {% for keyword in filters.available_filters.keywords %}
                    <option value="{{ keyword }}" {% if keyword in preferences.user_preferences.keyword_preferences %}selected{% endif %}>
                        {{ keyword }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Bouton de soumission pour mettre √† jour -->
        <button type="submit" class="btn btn-primary">Mettre √† jour</button>
    </form>

   <!-- Formulaire pour supprimer des pr√©f√©rences -->
<form method="POST" action="{{ url_for('main.user_preferences') }}" class="mt-4">
    <input type="hidden" name="delete_action" value="1"> <!-- Simule DELETE -->

    <h5>Supprimer des pr√©f√©rences</h5>

    <!-- S√©lection des pr√©f√©rences √† supprimer -->
    <div class="mb-3">
        <label for="delete_sources" class="form-label">Sources d'articles √† supprimer :</label>
        <select id="delete_sources" name="source_preferences" class="form-select" multiple>
            {% for source in preferences.user_preferences.source_preferences %}
                <option value="{{ source }}">{{ source }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="delete_video_channels" class="form-label">Cha√Ænes vid√©o √† supprimer :</label>
        <select id="delete_video_channels" name="video_channel_preferences" class="form-select" multiple>
            {% for channel in preferences.user_preferences.video_channel_preferences %}
                <option value="{{ channel }}">{{ channel }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="delete_keywords" class="form-label">Mots-cl√©s √† supprimer :</label>
        <select id="delete_keywords" name="keyword_preferences" class="form-select" multiple>
            {% for keyword in preferences.user_preferences.keyword_preferences %}
                <option value="{{ keyword }}">{{ keyword }}</option>
            {% endfor %}
        </select>
    </div>

    <button type="submit" class="btn btn-danger">Supprimer les pr√©f√©rences s√©lectionn√©es</button>
</form>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const preferences = {{ preferences | tojson }};
        const filters = {{ filters | tojson }};
        
        // V√©rification de l'existence des filtres avant d'essayer de les utiliser
        if (filters.available_filters && filters.available_filters.sources && filters.available_filters.video_channels && filters.available_filters.keywords) {
            // Fonction pour remplir une liste d√©roulante avec des options, et v√©rifier les √©l√©ments s√©lectionn√©s
            function populateSelect(selectId, options, selectedOptions) {
                const select = document.getElementById(selectId);
                select.innerHTML = '';  // Vider les options existantes
                
                options.forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;

                    // Si l'option est s√©lectionn√©e dans les pr√©f√©rences, on l'ajoute comme s√©lectionn√©e
                    if (selectedOptions.includes(optionValue)) {
                        option.selected = true;
                    }

                    select.appendChild(option);
                });
            }

            // Remplir chaque liste d√©roulante avec les donn√©es appropri√©es
            populateSelect('source_preferences', filters.available_filters.articles, preferences.source_preferences || []);
            populateSelect('video_channel_preferences', filters.available_filters.videos, preferences.video_channel_preferences || []);
            populateSelect('keyword_preferences', filters.available_filters.keywords, preferences.keyword_preferences || []);
        } else {
            console.error('Les donn√©es des filtres ne sont pas d√©finies correctement.', filters);
        }
    });
</script>

{% endblock %}
